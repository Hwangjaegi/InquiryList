<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>DIDIM-Login</title>
    <link href="/image/didimIcon.png" rel="icon" type="image/png">
    <link rel="stylesheet" th:href="@{/css/index.css}">
</head>
<body>

<!-- 가입 성공 및 실패 처리 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    let successMessage = /*[[${successMessage}]]*/ null;
    let errorMessage = /*[[${errorMessage}]]*/ null;
    let loginErrorMessage = /*[[${loginErrorMessage}]]*/ null;

    if (successMessage !== null) {
        alert(successMessage);
    }

    if (errorMessage !== null) {
        alert(errorMessage);
    }
    <!-- 시큐리티 로그인 에러 -->
    if (loginErrorMessage !== null) {
        alert(loginErrorMessage);
    }
    /*]]>*/
</script>

<div class="container" id="container">
    <!-- FORM SECTION -->
    <div class="row">
        <!-- SIGN UP -->
        <div class="col align-items-center flex-col sign-up">
            <div class="form-wrapper align-items-center">
                <!-- 회원가입 폼 -->
                <form action="/signup" class="form sign-up" id="signupForm" method="post">
                    <div class="input-group">
                        <i class='bx bxs-customerCode'></i>
                        <input name="customerCode" placeholder="고객코드" required type="text">
                    </div>
                    <div class="input-group" style="position:relative;">
                        <i class='bx bxs-user'></i>
                        <input autocomplete="off" id="signupUsername" name="username" placeholder="아이디" required type="text">
                    </div>
                    <div class="input-group">
                        <i class='bx bxs-lock-alt'></i>
                        <input name="password" placeholder="비밀번호" required type="password">
                    </div>
                    <div class="input-group">
                        <i class='bx bxs-lock-alt'></i>
                        <input name="name" placeholder="이름" required type="text">
                    </div>
                    <div class="input-group">
                        <i class='bx bx-mail-send'></i>
                        <input name="email" placeholder="이메일" required type="email">
                    </div>
                    <div class="input-group">
                        <i class='bx bxs-lock-alt'></i>
                        <input id="phoneInput" maxlength="13" name="tel"
                               placeholder="전화번호 (Ex: 031-123-4567 , 010-1234-5678)" required type="text">
                    </div>
                    <input name="role" type="hidden" value="USER">
                    <button id="signupBtn" type="submit">회원가입</button>
                    <!-- 아래 문장 유지 -->
                    <p>
                        <span>이미 계정이 있으신가요?</span>
                        <b class="pointer" onclick="toggle()">로그인</b>
                    </p>
                </form>
            </div>

        </div>
        <!-- END SIGN UP -->
        <!-- SIGN IN -->
        <div class="col align-items-center flex-col sign-in">
            <div class="form-wrapper align-items-center">
                <form action="/signin" class="form sign-in" id="sign-in-form" method="post">
                    <div class="input-group">
                        <i class='bx bxs-user'></i>
                        <input id="customerCodeInput" placeholder="고객코드" required type="text">
                    </div>
                    <div class="input-group">
                        <i class='bx bxs-user'></i>
                        <input id="usernameInput"  placeholder="아이디" required type="text">
                    </div>
                    <div class="input-group">
                        <i class='bx bxs-lock-alt'></i>
                        <input name="password" placeholder="비밀번호" required type="password">
                    </div>
                    <input id="combinedUsername" name="username" type="hidden">
                    <button type="submit">
                        로그인
                    </button>
                    <p>
                        <b>
                            암호를 잊어버리셨나요?
                        </b>
                    </p>
                    <p>
                <span>
                    회원가입이 필요하신가요?
                </span>
                        <b class="pointer" onclick="toggle()">
                            회원가입
                        </b>
                    </p>
                </form>
            </div>
            <div class="form-wrapper">
            </div>
        </div>
        <!-- END SIGN IN -->
    </div>
    <!-- END FORM SECTION -->
    <!-- CONTENT SECTION -->
    <div class="row content-row">
        <!-- SIGN IN CONTENT -->
        <div class="col align-items-center flex-col">
            <div class="text sign-in">
                <h2>
                    DIDIM SOLUTION
                </h2>

            </div>
            <div class="img sign-in">

            </div>
        </div>
        <!-- END SIGN IN CONTENT -->
        <!-- SIGN UP CONTENT -->
        <div class="col align-items-center flex-col">
            <div class="img sign-up">

            </div>
            <div class="text sign-up">
                <h2>
                    회원가입
                </h2>
            </div>
        </div>
        <!-- END SIGN UP CONTENT -->
    </div>
    <!-- END CONTENT SECTION -->
</div>

<!-- 전화번호 자동 하이픈 추가 스크립트 -->
<script>
    function formatPhoneNumber(phoneNumber) {
        // 숫자만 추출
        const cleaned = phoneNumber.replace(/\D/g, '');

        // 길이에 따라 포맷 적용
        if (cleaned.length <= 2) {
            return cleaned;
        } else if (cleaned.length <= 3) {
            return cleaned;
        } else if (cleaned.length <= 4) {
            return cleaned.slice(0, 2) + '-' + cleaned.slice(2);
        } else if (cleaned.length <= 6) {
            return cleaned.slice(0, 2) + '-' + cleaned.slice(2);
        } else if (cleaned.length <= 7) {
            return cleaned.slice(0, 2) + '-' + cleaned.slice(2, 5) + '-' + cleaned.slice(5);
        } else if (cleaned.length <= 8) {
            // 8자리: 지역번호 3자리 + 국번 4자리 + 번호 1자리 (02-1234-5)
            if (cleaned.startsWith('02')) {
                return cleaned.slice(0, 2) + '-' + cleaned.slice(2, 6) + '-' + cleaned.slice(6);
            } else {
                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 6) + '-' + cleaned.slice(6);
            }
        } else if (cleaned.length <= 9) {
            // 9자리: 지역번호 2자리 + 국번 3자리 + 번호 4자리 (02-123-4567)
            //       또는 지역번호 3자리 + 국번 3자리 + 번호 3자리 (031-123-4567)
            if (cleaned.startsWith('02')) {
                return cleaned.slice(0, 2) + '-' + cleaned.slice(2, 5) + '-' + cleaned.slice(5);
            } else {
                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 6) + '-' + cleaned.slice(6);
            }
        } else if (cleaned.length <= 10) {
            // 10자리: 지역번호 2자리 + 국번 4자리 + 번호 4자리 (02-1234-5678)
            //        또는 지역번호 3자리 + 국번 3자리 + 번호 4자리 (031-123-4567)
            if (cleaned.startsWith('02')) {
                return cleaned.slice(0, 2) + '-' + cleaned.slice(2, 6) + '-' + cleaned.slice(6);
            } else {
                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 6) + '-' + cleaned.slice(6);
            }
        } else {
            // 11자리: 휴대폰 번호 (010-1234-5678) 또는 지역번호 3자리 + 국번 4자리 + 번호 4자리
            if (cleaned.startsWith('010') || cleaned.startsWith('011') || cleaned.startsWith('016') ||
                cleaned.startsWith('017') || cleaned.startsWith('018') || cleaned.startsWith('019')) {
                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 7) + '-' + cleaned.slice(7, 11);
            } else {
                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 7) + '-' + cleaned.slice(7, 11);
            }
        }
    }

    // 페이지 로드 시 이벤트 리스너 추가
    document.addEventListener('DOMContentLoaded', function() {
        const phoneInput = document.getElementById('phoneInput');

        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                const cursorPosition = e.target.selectionStart;
                const oldValue = e.target.value;
                const newValue = formatPhoneNumber(e.target.value);

                e.target.value = newValue;

                // 커서 위치 조정 (하이픈 추가로 인한 위치 변경 보정)
                const diff = newValue.length - oldValue.length;
                if (diff > 0) {
                    e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
                }
            });

            // 키보드 이벤트 처리 (백스페이스 등)
            phoneInput.addEventListener('keydown', function(e) {
                // 백스페이스로 하이픈 삭제 시 앞 숫자도 함께 삭제
                if (e.key === 'Backspace') {
                    const cursorPosition = e.target.selectionStart;
                    const value = e.target.value;

                    if (cursorPosition > 0 && value[cursorPosition - 1] === '-') {
                        e.preventDefault();
                        const newValue = value.substring(0, cursorPosition - 2) + value.substring(cursorPosition);
                        e.target.value = formatPhoneNumber(newValue);
                        e.target.setSelectionRange(cursorPosition - 2, cursorPosition - 2);
                    }
                }
            });
        }


        const signInForm = document.getElementById('sign-in-form');
        const usernameInput = document.getElementById('usernameInput');
        const customerCodeInput = document.getElementById('customerCodeInput');
        const combinedUsernameInput = document.getElementById('combinedUsername');

        signInForm.addEventListener('submit', function (e) {
            // username|customerCode 형식으로 조합하여 히든 필드에 설정
            combinedUsernameInput.value = `${usernameInput.value}|${customerCodeInput.value}`;
        });

        // 로그인 후 뒤로가기 시 캐싱 데이터 초기화
        window.addEventListener('pageshow', function(event) {
            usernameInput.value = '';
            customerCodeInput.value = '';
            combinedUsernameInput.value = '';
        });


        // 로그인 후 뒤로가기 시 캐싱 데이터 초기화
        window.addEventListener('pageshow', function(event){
            document.getElementById('usernameInput').value = '';
            document.getElementById('customerCodeInput').value = '';
        });

        const signupUsernameInput = document.getElementById('signupUsername');
        const signupPasswordInput = document.querySelector('input[name="password"]');
        const signupBtn = document.getElementById('signupBtn');
        let usernameChecked = false;
        let passwordValid = false;
        // 메시지 div 동적 생성 (signupBtn 위에, 각각 별도)
        function getOrCreateMsgDiv(id, color) {
            let msgDiv = document.getElementById(id);
            if (!msgDiv) {
                msgDiv = document.createElement('div');
                msgDiv.id = id;
                msgDiv.style.fontSize = '0.95em';
                msgDiv.style.marginBottom = '4px';
                msgDiv.style.minHeight = '18px';
                msgDiv.style.color = color;
                signupBtn.parentNode.insertBefore(msgDiv, signupBtn);
            }
            return msgDiv;
        }
        // 아이디 중복확인 (blur)
        signupUsernameInput.addEventListener('blur', function() {
            const username = signupUsernameInput.value.trim();
            const idMsgDiv = getOrCreateMsgDiv('signupIdMsgDiv', 'red');
            if (!username) {
                idMsgDiv.textContent = '';
                usernameChecked = false;
                signupBtn.disabled = true;
                return;
            }
            fetch(`/api/check-username?username=${encodeURIComponent(username)}`, { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.exists) {
                        idMsgDiv.textContent = '사용할 수 없는 아이디입니다. 다른 아이디를 입력해주세요';
                        idMsgDiv.style.color = 'red';
                        usernameChecked = false;
                        signupBtn.disabled = true;
                    } else {
                        idMsgDiv.textContent = '사용할 수 있는 아이디입니다!';
                        idMsgDiv.style.color = 'green';
                        usernameChecked = true;
                        if (passwordValid) signupBtn.disabled = false;
                    }
                })
                .catch(() => {
                    idMsgDiv.textContent = '서버 오류. 다시 시도하세요.';
                    idMsgDiv.style.color = 'red';
                    usernameChecked = false;
                    signupBtn.disabled = true;
                });
        });
        // username 입력값이 바뀌면 메시지 div는 지우기만 (생성X)
        signupUsernameInput.addEventListener('input', function() {
            const idMsgDiv = document.getElementById('signupIdMsgDiv');
            if (idMsgDiv) idMsgDiv.textContent = '';
            usernameChecked = false;
            signupBtn.disabled = true;
        });
        // 패스워드 길이 체크 (blur 시점에만 메시지 div 생성/표시)
        signupPasswordInput.addEventListener('blur', function() {
            const pwMsgDiv = getOrCreateMsgDiv('signupPwMsgDiv', 'red');
            const password = signupPasswordInput.value;
            if (password.length < 8) {
                pwMsgDiv.textContent = '패스워드는 8자리 이상으로 사용해주세요.';
                pwMsgDiv.style.color = 'red';
                pwMsgDiv.style.display = '';
                passwordValid = false;
                signupBtn.disabled = true;
            } else {
                pwMsgDiv.textContent = '';
                pwMsgDiv.style.display = 'none'; // 메시지 div 숨김
                passwordValid = true;
                if (usernameChecked) signupBtn.disabled = false;
            }
        });
        signupPasswordInput.addEventListener('input', function() {
            const pwMsgDiv = document.getElementById('signupPwMsgDiv');
            if (pwMsgDiv) {
                pwMsgDiv.textContent = '';
                pwMsgDiv.style.display = 'none'; // 메시지 div 숨김
            }
            passwordValid = false;
            signupBtn.disabled = true;
        });
        // 회원가입 submit 시 체크
        document.getElementById('signupForm').addEventListener('submit', function(e) {
            const idMsgDiv = getOrCreateMsgDiv('signupIdMsgDiv', 'red');
            const pwMsgDiv = getOrCreateMsgDiv('signupPwMsgDiv', 'red');
            if (!usernameChecked) {
                e.preventDefault();
                idMsgDiv.textContent = '아이디 중복확인을 해주세요.';
                idMsgDiv.style.color = 'red';
            }
            if (!passwordValid) {
                e.preventDefault();
                pwMsgDiv.textContent = '패스워드는 8자리 이상으로 사용해주세요.';
                pwMsgDiv.style.color = 'red';
            }
        });
    });
</script>

<script th:src="@{/js/index.js}"></script>
</body>
</html>